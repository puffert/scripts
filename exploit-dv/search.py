#!/usr/bin/env python3
import argparse
import pykd
import textwrap

def main(args):
    choice_table = {"byte": "b", "ascii": "a", "unicode": "u"}
    command = f"s -{choice_table.get(args.type)} 0 L?80000000 {args.pattern}"
    print(f'[=] Running command: {command}')
    result = pykd.dbgCommand(command)

    if result is None:
        return print('[*] No results returned')

    print("\n[+] Search Results:")
    addresses = result.strip().split()

    for i, addr in enumerate(addresses, start=1):
        print(f"  {i}. Address: {addr}")
        if args.type != "byte":
            content = pykd.dbgCommand(f"da {addr} L10")
            if content:
                print(textwrap.indent(content.strip(), "    "))

    print("\n[+] Total Matches Found:", len(addresses))

if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="Searches memory for the given search term"
    )

    parser.add_argument(
        "-t",
        "--type",
        default="byte",
        choices=["byte", "ascii", "unicode"],
        help="data type to search for (default: byte)",
    )
    parser.add_argument(
        "pattern",
        help="what you want to search for",
    )

    args = parser.parse_args()

    main(args)
